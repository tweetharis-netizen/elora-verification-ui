"use strict";(()=>{var e={};e.id=9589,e.ids=[9589],e.modules={145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6113:e=>{e.exports=require("crypto")},6930:(e,t,n)=>{n.r(t),n.d(t,{config:()=>p,default:()=>c,routeModule:()=>d});var r={};n.r(r),n.d(r,{config:()=>u,default:()=>handler});var i=n(1802),s=n(7153),a=n(6249),l=n(4946),o=n(2414);let u={api:{bodyParser:{sizeLimit:"6mb"}}};function clampStr(e,t=2400){if("string"!=typeof e)return"";let n=e.trim();return n.length<=t?n:n.slice(0,t)}function stripMarkdownToPlainText(e){let t=String(e||"");return(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=t.replace(/```[\s\S]*?```/g,"")).replace(/`+/g,"")).replace(/^\s{0,3}#{1,6}\s+/gm,"")).replace(/\*\*([^*]+)\*\*/g,"$1")).replace(/\*([^*]+)\*/g,"$1")).replace(/__([^_]+)__/g,"$1")).replace(/_([^_]+)_/g,"$1")).replace(/^\s*>\s?/gm,"")).replace(/\[([^\]]+)\]\(([^)]+)\)/g,"$1")).replace(/^\s*([-*_])\1\1+\s*$/gm,"")).replace(/\n{3,}/g,"\n\n").trim()}function normalizeMathToPlainText(e){let t=String(e||"");return(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=t.replace(/\$\$[\s\S]*?\$\$/g,e=>e.replace(/\$/g,""))).replace(/\$([^$]+)\$/g,"$1")).replace(/\\frac\s*{([^}]+)}\s*{([^}]+)}/g,"$1/$2")).replace(/\\times/g,"\xd7")).replace(/\\div/g,"\xf7")).replace(/\\cdot/g,"\xd7")).replace(/\\sqrt\s*{([^}]+)}/g,"sqrt($1)")).replace(/\\left|\\right/g,"")).replace(/\\\(|\\\)/g,"")).replace(/\\\[|\\\]/g,"")).replace(/\\text\s*{([^}]+)}/g,"$1")).replace(/<\s*internal\s*>[\s\S]*?<\s*\/\s*internal\s*>/gi,"")).replace(/<\s*internal\s*\/\s*>/gi,"")).replace(/<\s*internal\s*>/gi,"")).trim()}function isTeacherOnlyAction(e){return new Set(["lesson","worksheet","assessment","slides"]).has(String(e||""))}async function callOpenRouter({apiKey:e,messages:t}){let n=await fetch("https://openrouter.ai/api/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({model:"openai/gpt-4o-mini",messages:t,temperature:.2,max_tokens:900})}),r=await n.json().catch(()=>null);return{ok:n.ok,status:n.status,data:r}}async function handler(e,t){if("POST"!==e.method)return t.setHeader("Allow","POST"),t.status(405).json({error:"Method not allowed"});let n=process.env.OPENROUTER_API_KEY;if(!n)return t.status(500).json({error:"Missing OPENROUTER_API_KEY"});try{let r=e.body||{},i=clampStr(r.role||"student",20),s=clampStr(r.country||"Singapore",60),a=clampStr(r.level||"Primary 1",60),u=clampStr(r.subject||"General",60),c=clampStr(r.topic||"",120),p=clampStr(r.action||"explain",20),d=clampStr(r.message||"",2400),m=function(e,t,n,r){let i=Number(e);return Number.isFinite(i)?Math.max(0,Math.min(3,Math.floor(i))):0}(r.attempt,0,0,0),h=clampStr(r.imageDataUrl||"",6e6),f=!!(h&&h.startsWith("data:image/"));if(!d&&!f)return t.status(400).json({error:"Missing message."});let g=(0,l.pX)(e),y=await (0,l.Eo)(g),w=!!y?.verified,b=!!(0,o.nS)(e);if("educator"===i&&!w)return t.status(403).json({error:"Please verify your email to use Educator mode."});let S=function(e,t){let n=String(e||"").toLowerCase();return n.includes("check my answer")||n.includes("is this correct")||n.includes("is it correct")||n.includes("am i correct")||n.includes("did i get it right")||n.includes("right or wrong")||n.includes("validate")||/\bmy answer\b/.test(n)||/\banswer\s*:\s*/.test(n)||/\b=\s*-?\d/.test(n)?"check":n.includes("lesson plan")||n.includes("plan a lesson")||n.includes("curriculum")?"lesson":n.includes("worksheet")||n.includes("practice sheet")?"worksheet":n.includes("assessment")||n.includes("test")||n.includes("quiz")||n.includes("exam")?"assessment":n.includes("slides")||n.includes("powerpoint")||n.includes("presentation")?"slides":n.includes("study plan")||n.includes("how to study")||n.includes("revision")?"study":n.includes("explain")||n.includes("what is")||n.includes("how does")?"explain":String(t||"explain")}(d,p);if(isTeacherOnlyAction(S)&&!b)return t.status(403).json({error:"Teacher tools are locked. Redeem a Teacher Invite Code in Settings to unlock them."});if("student"===i&&"check"===S&&!f){let e=function(e){let t=String(e||"").trim();if(!t)return null;let n=t.lastIndexOf("="),r="",i="";if(-1!==n)r=t.slice(0,n).trim(),i=t.slice(n+1).trim();else{let e=t.match(/\b(my answer is|answer\s*:)\s*([^\n\r]+)$/i);e&&(i=String(e[2]||"").trim(),r=t.slice(0,e.index).trim())}if(!i)return null;if(!r){let e=t.match(/([\d\s().,+\-/*÷×%]+)\s*(?:=|$)/);r=e?String(e[1]||"").trim():""}if(!r)return null;let s=function(e){let t=function(e){let t=String(e||"").replace(/×/g,"*").replace(/÷/g,"/").replace(/[–—]/g,"-"),n=[],r=0,isDigit=e=>e>="0"&&e<="9",isOp=e=>"+"===e||"-"===e||"*"===e||"/"===e;for(;r<t.length;){let e=t[r];if(" "===e||"	"===e||"\n"===e||"\r"===e){r++;continue}if("("===e||")"===e){n.push({type:"paren",value:e}),r++;continue}if(isOp(e)){n.push({type:"op",value:e}),r++;continue}if(isDigit(e)||"."===e){let e=r;for(;e<t.length&&(isDigit(t[e])||"."===t[e]||","===t[e]);)e++;let i=t.slice(r,e).replace(/,/g,"");if(e<t.length&&"/"===t[e]){let s=e+1;for(;s<t.length&&(isDigit(t[s])||","===t[s]);)s++;let a=t.slice(e+1,s).replace(/,/g,"");if(!a)return null;let l=Number(i),o=Number(a);if(!Number.isFinite(l)||!Number.isFinite(o)||0===o)return null;n.push({type:"num",value:l/o}),r=s;continue}let s=Number(i);if(!Number.isFinite(s))return null;e<t.length&&"%"===t[e]&&(s/=100,e++),n.push({type:"num",value:s}),r=e;continue}return null}let i=[];for(let e=0;e<n.length;e++){let t=n[e];if("op"===t.type&&"-"===t.value){let e=i[i.length-1],t=!e||"op"===e.type||"paren"===e.type&&"("===e.value;if(t){i.push({type:"num",value:0}),i.push({type:"op",value:"-"});continue}}i.push(t)}return i}(e);if(!t)return null;let n=function(e){let t=[],n=[],prec=e=>"+"===e||"-"===e?1:"*"===e||"/"===e?2:0;for(let r of e){if("num"===r.type){t.push(r);continue}if("op"===r.type){for(;n.length;){let e=n[n.length-1];if("op"===e.type&&prec(e.value)>=prec(r.value)){t.push(n.pop());continue}break}n.push(r);continue}if("paren"===r.type&&"("===r.value){n.push(r);continue}if("paren"===r.type&&")"===r.value){for(;n.length&&!("paren"===n[n.length-1].type&&"("===n[n.length-1].value);)t.push(n.pop());if(!n.length)return null;n.pop();continue}return null}for(;n.length;){let e=n.pop();if("paren"===e.type)return null;t.push(e)}return t}(t);return n?function(e){let t=[];for(let n of e){if("num"===n.type){t.push(n.value);continue}if("op"===n.type){let e=t.pop(),r=t.pop();if(!Number.isFinite(r)||!Number.isFinite(e))return null;if("+"===n.value)t.push(r+e);else if("-"===n.value)t.push(r-e);else if("*"===n.value)t.push(r*e);else{if("/"!==n.value||0===e)return null;t.push(r/e)}continue}return null}if(1!==t.length)return null;let n=t[0];return Number.isFinite(n)?n:null}(n):null}(r),a=function(e){let t=String(e||"").trim();if(!t)return null;let n=t.match(/^(-?\d+(?:\.\d+)?)\s*%$/);if(n){let e=Number(n[1]);return Number.isFinite(e)?e/100:null}let r=t.match(/^(-?\d+(?:\.\d+)?)\s*\/\s*(-?\d+(?:\.\d+)?)$/);if(r){let e=Number(r[1]),t=Number(r[2]);return Number.isFinite(e)&&Number.isFinite(t)&&0!==t?e/t:null}let i=Number(t.replace(/,/g,""));return Number.isFinite(i)?i:null}(i);if(null==s||null==a)return null;let l=function(e,t){let n=Number(e),r=Number(t);return!!(Number.isFinite(n)&&Number.isFinite(r))&&Math.abs(n-r)<=1e-9*Math.max(1,Math.abs(n),Math.abs(r))}(s,a);return{ok:l,exprStr:r.replace(/\s+/g," ").trim(),exprVal:s,ansVal:a}}(d);if(e){if(e.ok){let n=`Correct ✅
You evaluated "${e.exprStr}" correctly.
Your answer matches the result.`;return t.status(200).json({reply:n})}if(m>=3){let n=function(e){let t=Number(e);if(!Number.isFinite(t))return String(e);if(1e-12>Math.abs(t-Math.round(t)))return String(Math.round(t));let n=t.toString();return n.length<=12?n:t.toFixed(6).replace(/0+$/,"").replace(/\.$/,"")}(e.exprVal),r=`Not quite ❌
On attempt 3, here’s the correct result:
${e.exprStr} = ${n}

Steps:
1) Follow order of operations (brackets, then \xd7/\xf7, then +/−).
2) Compute carefully and compare with your answer.
`;return t.status(200).json({reply:r})}let n=`Not quite ❌
Hint (no final answer yet):
1) Re-check the order of operations.
2) Do one operation at a time and write the intermediate result.
3) Then compare with the answer you wrote.

Try again and send your updated answer like this:
${e.exprStr} = ?`;return t.status(200).json({reply:n})}}let x=function({role:e,country:t,level:n,subject:r,topic:i,action:s,attempt:a,hasImage:l,teacherRules:o,sentiment:u}){let c="educator"===e?`1. You are Elora, a Cinematic, High-Perception AI Learning Assistant.
- Educator Preference (STRICT): ${o||"Follow standard Elora pedagogical guidelines."}`:"parent"===e?"You are Elora, a warm, practical helper for parents supporting learning at home.":["You are Elora, a Cinematic, High-Perception AI Learning Assistant.","1. Adopt a world-class tutor persona: professional, encouraging, and highly adaptive.","supportive"===u?"CRITICAL: Student seems frustrated or stuck. Shift to a GENTLE, COACHING tone. Use encouraging phrases, break things down more than usual, and offer a short 'brain break' if they want.":"Keep a steady, professional, and encouraging tutor persona."].join("\n"),p=["Context:",`Country syllabus naming: ${t}`,`Level: ${n}`,`Subject: ${r}`,i?`Topic: ${i}`:null,l?"The user attached an image. Describe what you see briefly, then answer.":null].filter(Boolean).join("\n");return[c,"Default style rules:\n- Use plain language. Keep it calm, clear, and structured.\n- No raw LaTeX by default. Use human-readable math (e.g., '5 divided by 4 is 1.25').\n- If you must show math, use simple inline forms like 5/4 or 1.25.\n- Avoid saying 'likely' or sounding uncertain unless you truly cannot know.\n- If information is missing, ask ONE short clarifying question, otherwise make a reasonable assumption and state it briefly.","student"===e&&"check"===s?"Student Check Policy:\n- You are checking the student's answer.\n- If attempt is 1 or 2: do NOT reveal the final answer. Give hints and ask them to try again.\n- If attempt is 3: you may reveal the final answer and explain clearly.":"",p,"lesson"===s?"Output format: objectives, timings, steps, checks for understanding, differentiation.":"worksheet"===s?"Output format: student questions + optional teacher answers if teacher requested.":"assessment"===s||"quiz"===s?'Output format: A very brief (1-sentence) intro, then the <quiz_data> JSON block.\nRules: ONLY MCQ format. Clear title. 3-5 questions.\nJSON Structure: { "title": "Quiz Title", "questions": [ { "id": 1, "question": "text", "type": "mcq", "options": ["A", "B", "C", "D"], "answer": "Correct Option" } ] }\nDo NOT include a marking scheme or long text below the block unless requested. Hide data inside <quiz_data> tag.':"slides"===s?"Output format: slide titles + bullet content + short speaker notes.":"study"===s?"Output format: a realistic plan with small steps.":"coach"===s?"Output format: what to say/do at home, and a simple routine.":"message"===s?"Output format: a draft message with polite tone.":"check"===s?"Output format: verdict first (Correct/Not quite), then a short explanation/hints.":"Output format: short steps and one example if helpful."].filter(Boolean).join("\n\n")}({role:i,country:s,level:a,subject:u,topic:c,action:S,attempt:m,hasImage:!!h,teacherRules:r.teacherRules,sentiment:r.sentiment}),k=function({role:e,action:t,topic:n,message:r,attempt:i}){let s="student"===e&&"check"===t?`Attempt: ${i||0}/3. Follow the attempt policy strictly.`:"",a=n?`Topic focus: ${n}`:"";return["educator"===e?"Teacher request:":"parent"===e?"Parent request:":"Student request:",s,a,r].filter(Boolean).join("\n")}({role:i,action:S,topic:c,message:d,attempt:m}),v=function(e,t){let n=String(t?.role||"student"),r=String(t?.action||"explain"),i=Number(t?.attempt||0),s=String(t?.currentUserText||""),a=Array.isArray(e)?e:[];if(!a.length)return[];let l=a.slice(-12),o=[];for(let e of l){let t=String(e?.from||e?.role||"").toLowerCase(),a=String(e?.text||e?.content||"").trim();if(!a)continue;let l="elora"===t||"assistant"===t?"assistant":"user";if("student"===n&&"check"===r&&i<3&&"assistant"===l||"user"===l&&s&&a===s)continue;let u=stripMarkdownToPlainText(a).slice(0,1600).trim();u&&o.push({role:l,content:u})}return o}(r?.messages,{role:i,action:S,attempt:m,currentUserText:d}),{ok:N,data:T}=await callOpenRouter({apiKey:n,messages:[{role:"system",content:x},...v,{role:"user",content:f?[{type:"text",text:k},{type:"image_url",image_url:{url:h}}]:k}]});if(!N){let e=T?.error?.message||T?.error||JSON.stringify(T)||"AI request failed.";return console.error("OpenRouter Error Details:",{status:y,data:T}),t.status(500).json({error:`Elora's neural link is unstable. Details: ${String(e)}`})}let $=T?.choices?.[0]?.message?.content||"",O=isTeacherOnlyAction(S)||"quiz"===S||"assessment"===S,P=O?normalizeMathToPlainText($):stripMarkdownToPlainText(normalizeMathToPlainText($));if("student"===i&&"check"===S&&m>0&&m<3&&function(e){let t=String(e||"").toLowerCase();if(!t)return!1;if(t.includes("the answer is")||t.includes("final answer")||t.includes("correct answer")||/\b=\s*-?\d/.test(t))return!0;let n=t.split("\n").map(e=>e.trim()).filter(Boolean);return!!n.some(e=>e.length<=24&&/^[\d\s().,+\-/*÷×=]+$/.test(e)&&/\d/.test(e))}(P)){let e=x+`
Rewrite rule:
- Rewrite your previous reply so it contains NO final numeric answer and NO "the answer is". Keep only hints and next-step guidance.`,t=`Rewrite this response to follow the attempt policy strictly (no final answer):

${P}`,r=await callOpenRouter({apiKey:n,messages:[{role:"system",content:e},{role:"user",content:t}]});if(r.ok){let e=r.data?.choices?.[0]?.message?.content||"";P=stripMarkdownToPlainText(normalizeMathToPlainText(e))}else P="Not quite ❌\nI can’t reveal the final answer yet.\n\nHint:\n1) Re-check your first step.\n2) Send your next step (not the final answer), and I’ll guide you."}return t.status(200).json({reply:P})}catch(e){return console.error("API Error in Assistant Handler:",e),t.status(500).json({error:"Assistant failed. Details: "+(e.message||"Internal error")})}}let c=(0,a.l)(r,"default"),p=(0,a.l)(r,"config"),d=new i.PagesAPIRouteModule({definition:{kind:s.x.PAGES_API,page:"/api/assistant",pathname:"/api/assistant",bundlePath:"",filename:""},userland:r})}};var t=require("../../webpack-api-runtime.js");t.C(e);var __webpack_exec__=e=>t(t.s=e),n=t.X(0,[4222,4946,2414],()=>__webpack_exec__(6930));module.exports=n})();